repositories:
# Stable repo of official helm charts
- name: "gabibbo97"
  url: "https://gabibbo97.github.io/charts/"

releases:

#######################################################################################
## keycloak                                                                          ##
## Keycloak is an open source identity and access management system                  ##
#######################################################################################

#
# References:
#   - https://github.com/gabibbo97/charts/tree/master/charts/keycloak-gatekeeper
#   - https://hub.helm.sh/charts/gabibbo97/keycloak-gatekeeper
#   - https://www.keycloak.org/
#
{{ range $index, $service := (env "KEYCLOAK_GATEKEEPER_SERVICES" | splitList ",") }}
{{- $hosts := (env "KEYCLOAK_GATEKEEPER_HOSTS" | splitList ",") }}
{{- $upstreams := (env "KEYCLOAK_GATEKEEPER_UPSTREAMS" | splitList ",") }}
{{- $rules := (env "KEYCLOAK_GATEKEEPER_RULES" | splitList "#") }}
- name: "key-gate-{{- $service }}"
  namespace: "kube-system"
  labels:
    chart: "keycloak-gatekeeper"
    repo: "gabibbo97"
    component: "iap"
    namespace: "kube-system"
    vendor: "keycloak"
    default: "false"
  chart: "gabibbo97/keycloak-gatekeeper"
  version: "1.1.1"
  wait: false
  installed: true
  values:
  - image:
      tag: 5.0.0
      pullPolicy: "IfNotPresent"
    debug: {{ env "KEYCLOAK_GATEKEEPER_DEBUG" | default "false" }}
    replicas: {{ env "KEYCLOAK_GATEKEEPER_REPLICAS" | default 1 }}
    ingress:
      enabled: '{{ env "KEYCLOAK_GATEKEEPER_INGRESS_ENABLED" | default "true" }}'
      annotations:
        kubernetes.io/ingress.class: nginx
        nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
        kubernetes.io/tls-acme: "false"
        external-dns.alpha.kubernetes.io/target: '{{ requiredEnv "NGINX_INGRESS_HOSTNAME" }}'
        external-dns.alpha.kubernetes.io/ttl: "60"
      hosts:
      - {{ index $hosts $index }}.{{- requiredEnv "KOPS_CLUSTER_NAME" }}
      # tls:
      #  - secretName: keycloak-http-tls
      #    hosts:  [{{ env "KEYCLOAK_INGRESS_HOSTS" }}]
    discoveryURL: '{{- requiredEnv "KOPS_OIDC_ISSUER_URL" }}'
    upstreamURL: '{{- index $upstreams $index }}'
    skipUpstreamTlsVerify: true
    ClientID: 'kubernetes'
    ClientSecret: '{{- requiredEnv "KEYCLOAK_GATEKEEPER_DASHBOARD_CLIENT_SECRET" }}'
    scopes:
      - email
    rules:
      - {{ index $rules $index }}
    ### Optional: RBAC_ENABLED;
    rbac:
      create: {{ env "RBAC_ENABLED" | default "false" }}
    serviceAccount:
      create: {{ env "RBAC_ENABLED" | default "false" }}
      name: "key-gate-{{- $service }}"
    livenessProbe:
      timeoutSeconds: 60
    readinessProbe:
      timeoutSeconds: 90
    resources:
      limits:
        cpu: "100m"
        memory: "128Mi"
      requests:
        cpu: "10m"
        memory: "10Mi"
{{- end }}
